---
import BlogListItem from "@components/BlogListItem.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection } from "astro:content";

// Fetch all non-draft posts, newest first
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Collect all unique tags across all posts
const allTags = [...new Set(posts.flatMap((p) => p.data.tags))].sort();
---

<Layout
  title="Blog"
  description="Writing on frontend development, accessibility, CSS, TypeScript and the craft of building for the web."
>
  <div class="container">
    <header class="page-hero animate-in">
      <span class="page-hero__eyebrow">Writing</span>
      <h1 class="page-hero__title">Blog</h1>
      <p class="page-hero__subtitle">
        Thoughts on frontend development, accessibility, and the craft of
        building for the web.
      </p>
    </header>

    {
      allTags.length > 0 && (
        <nav
          class="tag-filter animate-in animate-in--delay-1"
          aria-label="Filter posts by tag"
        >
          <ul class="tag-filter__list" role="list">
            <li>
              <a href="/blog" class="tag" id="tag-all">
                All
              </a>
            </li>
            {allTags.map((tag) => (
              <li>
                <a
                  href={`/blog?tag=${encodeURIComponent(tag)}`}
                  class="tag"
                  data-tag={tag}
                >
                  {tag}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      )
    }

    <ol
      class="blog-list animate-in animate-in--delay-2"
      role="list"
      aria-live="polite"
    >
      {
        posts.map((post) => (
          <li
            class="blog-list__item"
            data-tags={JSON.stringify(post.data.tags)}
          >
            <BlogListItem post={post} />
          </li>
        ))
      }
    </ol>

    <p class="blog-empty" id="blog-empty" style="display: none;">
      No posts found for this tag.
      <a href="/blog">View all posts</a>.
    </p>
  </div>
</Layout>

<script>
  const params = new URLSearchParams(window.location.search);
  const activeTag = params.get("tag");

  const allLink = document.getElementById("tag-all")!;
  const emptyMsg = document.getElementById("blog-empty")!;
  const posts = document.querySelectorAll<HTMLElement>(".blog-list__item");

  if (activeTag) {
    // Update active state on tag links
    allLink.classList.remove("tag--active");
    allLink.removeAttribute("aria-current");

    document.querySelectorAll<HTMLElement>("a[data-tag]").forEach((link) => {
      const isActive = link.dataset.tag === activeTag;
      link.classList.toggle("tag--active", isActive);
      if (isActive) {
        link.setAttribute("aria-current", "true");
      }
    });

    // Filter posts
    let visibleCount = 0;
    posts.forEach((post) => {
      const tags: string[] = JSON.parse(post.dataset.tags ?? "[]");
      const matches = tags.includes(activeTag);
      post.style.display = matches ? "" : "none";

      if (matches) {
        visibleCount++;
      }
    });

    // Show empty message if no posts match
    emptyMsg.style.display = visibleCount === 0 ? "" : "none";
  } else {
    // No tag selected â€” "All" is active
    allLink.classList.add("tag--active");
    allLink.setAttribute("aria-current", "true");
  }
</script>

<style>
  .tag-filter {
    margin-block-end: var(--space-10);
  }

  .tag-filter__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .tag--active {
    background-color: var(--color-accent-bg);
    color: #ffffff !important;

    &:hover {
      background-color: var(--color-accent-hover);
      color: #ffffff !important;
    }
  }

  .blog-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    list-style: none;
    margin: 0;
    padding-block-end: var(--space-24);
    padding: 0;
  }

  .blog-list__item {
    border-block-end: 1px solid var(--color-border-light);
  }

  .blog-empty {
    color: var(--color-text-muted);
    font-size: var(--text-md);
    padding-block: var(--space-12);
  }
</style>
